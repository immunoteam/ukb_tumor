---
title: "B_025_Franco_and_GWAS"
output: html_document
date: "2025-06-06"
---

#Setup

```{r}
setwd("/media/balazs/WorkL/balazs/Work/UKBiobank/")
#library(survival, lib.loc = "/home/balazs/R/x86_64-pc-linux-gnu-library/4.3")
Packages <- c("tidyverse", "data.table", "magrittr", "future.apply", "fastmatch", "clusterProfiler", "org.Hs.eg.db", "stringi", "forestmodel", "ggsurvfit")
#, "hgnc", , , "survival", "pbapply", , "gridExtra", "ggpubr", "rvest", "Rfast", , , , , "tidycmprsk", , "survminer", , , , "ComplexHeatmap", , , , "ggrepel", "ggsci", "scales", , "circlize" "fastmatch", "h2o", , , "protr", , , "networkD3", , , "Biostrings", ,
lapply(Packages, require, character.only = TRUE)
rm(Packages)
options(dplyr.summarise.inform = FALSE)

# pal_npg("nrc")(9)
# scales::show_col(pal_npg("nrc")(9))
# pal_npg("nrc", alpha = 0.8)(9)
# scales::show_col(pal_npg("nrc", alpha = 0.8)(9))
options(future.globals.maxSize= 2147483648)
source("/home/balazs/mygit/ukb_tumor/scripts/B_Incidence_functions.R")
plan(multisession(workers = 4))
```

#PTV burden

```{r}
res = readRDS("Res/017/res_gsea_c7.rds")
FRANCOensgs = unlist(strsplit(res$genesENS[res$ptv_type == "55_FRANCO_BLOOD_SANOFI_PASTEUR_SA_INACTIVATED_INFLUENZA_VACCINE_CORRELATED_WITH_ANTIBODY_RESPONSE_AGE_18_40YO_14DY_POSITIVE"][1], ";"))
gene_match_franco = data.frame(SYMBOL = unlist(strsplit(res$genesHugo[res$ptv_type == "55_FRANCO_BLOOD_SANOFI_PASTEUR_SA_INACTIVATED_INFLUENZA_VACCINE_CORRELATED_WITH_ANTIBODY_RESPONSE_AGE_18_40YO_14DY_POSITIVE"][1], ";")), ENSEMBL = unlist(strsplit(res$genesENS[res$ptv_type == "55_FRANCO_BLOOD_SANOFI_PASTEUR_SA_INACTIVATED_INFLUENZA_VACCINE_CORRELATED_WITH_ANTIBODY_RESPONSE_AGE_18_40YO_14DY_POSITIVE"][1], ";")))
saveRDS(gene_match_franco, file = "Objects/025/FRANCO_influvac_genes.rds")
rm(res)

c("ZBTB46", "PIWIL1", "B4GALT4-AS1", "CRYGEP, RPL12P17", "NBAS", "KCNMA1", "ARHGAP26", "HECW2", "ERICH6, SELENOT", "PMP22, TEKT3", "EMP1, LINC01559", "OSBPL3, CYCS", "MRPS21P6, RPS27P18", "HNRNPA3P8, HYDINP1")
hugo_symbols_gwas = c("ZBTB46", "PIWIL1", "B4GALT4-AS1", "CRYGEP", "RPL12P17", "NBAS", "KCNMA1", "ARHGAP26", "HECW2", "ERICH6", "SELENOT", "PMP22", "TEKT3", "EMP1", "LINC01559", "OSBPL3" , "CYCS", "MRPS21P6", "RPS27P18", "HNRNPA3P8", "HYDINP1")
gwas = bitr(geneID = hugo_symbols_gwas, fromType = "SYMBOL", toType = "ENSEMBL", OrgDb = "org.Hs.eg.db")
hugo_symbols_gwas[!hugo_symbols_gwas %in% gwas$SYMBOL]
gwas = rbind(gwas, 
             c(SYMBOL = "RPL12P17", ENSEMBL = "ENSG00000224839"), 
             c(SYMBOL = "MRPS21P6", ENSEMBL = "ENSG00000214298"))
gwas$reported_trait = NA
gwas$reported_trait[gwas$SYMBOL %in% c("OSBPL3", "CYCS", "MRPS21P6", "RPS27P18", "HNRNPA3P8", "HYDINP1")] = "T cell lymphocyte profile difference (90 days post influenza vaccination)"
gwas$reported_trait[gwas$SYMBOL %in% c("B4GALT4-AS1", "RPL12P17", "CRYGEP", "NBAS", "KCNMA1", "ARHGAP26")] = "B cell lymphocyte profile difference (7 days post influenza vaccination)"
gwas$reported_trait[gwas$SYMBOL %in% c("EMP1", "LINC01559")] = "T cell lymphocyte profile difference (7 days post influenza vaccination)"
gwas$reported_trait[gwas$SYMBOL %in% c("HECW2", "ERICH6", "SELENOT")] = "B cell lymphocyte profile difference (90 days post influenza vaccination)"
gwas$reported_trait[gwas$SYMBOL %in% c("PMP22", "TEKT3")] = "T cell lymphocyte profile difference (1 day post influenza vaccination)"
gwas$reported_trait[gwas$SYMBOL == "PIWIL1"] = "B cell lymphocyte profile difference (1 day post influenza vaccination)"
gwas$reported_trait[gwas$SYMBOL == "ZBTB46"] = "Response to influenza vaccine"

saveRDS(gwas, file = "Objects/025/GWAS_influvac_genes.rds")


ptvb_MAF104 = fread("PTVvars/MAF10_4_all_retained_variants_PTVBurden_final_Shetscores.tsv")
ptvb_MAF104 %<>% dplyr::select(Patient.ID, Genes) %>% set_colnames(c("eid", "ptvgenes"))

ukb_ptvENSG = as.list(ptvb_MAF104$ptvgenes)
ukb_ptvENSG = lapply(ukb_ptvENSG, function(x) unique(unlist(strsplit(x, ","), use.names = F)))
names(ukb_ptvENSG) = ptvb_MAF104$eid
rm(ptvb_MAF104)

tempensgs = c(FRANCOensgs, gwas$ENSEMBL)

ptv_data = future_sapply(ukb_ptvENSG, function(u) {
  sum(u %fin% tempensgs)
})
table(ptv_data)
saveRDS(ptv_data, file = "Objects/025/ptvb_FRANCO_GWAS.rds")

```

#Incidence, survival

```{r}
#res = readRDS("Res/017/res_gsea_c7.rds")

source("/home/balazs/mygit/ukb_tumor/scripts/B_Incidence_functions.R")
franco = readRDS("Objects/025/FRANCO_influvac_genes.rds")
gwas = readRDS("Objects/025/GWAS_influvac_genes.rds")
res_fishtest = readRDS("Res/010/res_fishtest_104.rds")

res_fishtest %>% filter(ENSEMBL %in% gwas$ENSEMBL | SYMBOL %in% gwas$SYMBOL) %>% filter(category == "Lung_male") %>% arrange(desc(OR)) %>% left_join(gwas, by = "ENSEMBL") %>% View()
res_fishtest %>% filter(ENSEMBL %in% gwas$ENSEMBL | SYMBOL %in% gwas$SYMBOL) %>% filter(category == "Lung_male") %>% arrange(desc(OR)) %>% left_join(gwas, by = "ENSEMBL") %>% View()

res_fishtest %>% filter(ENSEMBL %in% gwas$ENSEMBL[grepl("B cell lymphocyte profile", gwas$reported_trait)], category == "Lung_male") %>% left_join(gwas, by = "ENSEMBL") %>% View() #5 genes show good trend, 
res_fishtest %>% filter(ENSEMBL %in% gwas$ENSEMBL[gwas$reported_trait == "B cell lymphocyte profile difference (7 days post influenza vaccination)"], category == "Lung_male") %>% left_join(gwas, by = "ENSEMBL") %>% View()
gwas$ENSEMBL[gwas$reported_trait == "B cell lymphocyte profile difference (7 days post influenza vaccination)"] #6


tumor = "Lung"
tumor = "Bladder"
tumor = "Thyroid"
tumor = "Multiplemyeloma"
tumor = "Mesothelioma"

tempensgs = franco$ENSEMBL
tempensgs = gwas$ENSEMBL

tempensgs = c(franco$ENSEMBL, gwas$ENSEMBL)
tempensgs = gwas$ENSEMBL[gwas$SYMBOL %in% c("KCNMA1", "ERICH6", "HECW2", "NBAS", "ARHGAP26")]
tempensgs = c(franco$ENSEMBL, gwas$ENSEMBL[gwas$SYMBOL %in% c("KCNMA1", "ERICH6", "HECW2", "NBAS", "ARHGAP26")])
tempensgs = c(franco$ENSEMBL[!franco$SYMBOL %in% c("MLH1", "CD79A", "PRKAB2", "SWSAP1", "CD19", "LRP5L")], gwas$ENSEMBL[gwas$SYMBOL %in% c("KCNMA1", "ERICH6", "HECW2", "NBAS", "ARHGAP26")])
temphugo = c(franco$SYMBOL[!franco$SYMBOL %in% c("MLH1", "CD79A", "PRKAB2", "SWSAP1", "CD19", "LRP5L")], gwas$SYMBOL[gwas$SYMBOL %in% c("KCNMA1", "ERICH6", "HECW2", "NBAS", "ARHGAP26")])

fun_TumorIncCoxModel(tumor = tumor, geneset = tempensgs)
fun_TumorIncCoxModel(tumor = tumor, gender = "male", geneset = tempensgs)
fun_TumorIncCoxModel(tumor = tumor, gender = "female", geneset = tempensgs) #Only trend

fun_TumorIncForestPlot(tumor = tumor, geneset = tempensgs)
fun_TumorIncForestPlot(tumor = tumor, gender = "male", geneset = tempensgs)
fun_TumorIncForestPlot(tumor = tumor, gender = "female", geneset = tempensgs) #Only trend

fun_TumorSurvPlotOS(tumor = tumor, geneset = tempensgs)
fun_TumorSurvPlotOS(tumor = tumor, gender = "male", geneset = tempensgs)
fun_TumorSurvPlotOS(tumor = tumor, gender = "female", geneset = tempensgs) #NO

fun_TumorSurvPlotDS(tumor = tumor, geneset = tempensgs)
fun_TumorSurvPlotDS(tumor = tumor, gender = "male", geneset = tempensgs)
fun_TumorSurvPlotDS(tumor = tumor, gender = "female", geneset = tempensgs) #NO

```

HR, P
Both gender, lung:
Franco: 1.658299e+00 4.019334e-05
GWAS: 1.248765 0.321668
BOTH geneset: 1.552473e+00 4.923834e-05

Male, lung:
Franco: 2.158683e+00 4.392221e-07
GWAS: 1.348785 0.301419
BOTH geneset: 1.927835e+00 1.255550e-06

Female, lung:
Franco: 1.1539583 0.4947589
GWAS: 1.1220646 0.7451234
BOTH geneset: 1.1520403 0.4342831


Both gender, bladder:
Franco: 1.55137207 0.03275136
GWAS: 0.7877785 0.5943624
BOTH geneset: 1.3357684 0.1223961

Male, bladder:
Franco: 1.75648240 0.01048295
GWAS: 0.7937013 0.6445723
BOTH geneset: 1.47932779 0.05262089


Female, bladder:
Franco: 0.8525283 0.7831865
GWAS: 0.7644889 0.7885766
BOTH geneset: 0.8310361 0.7128176


```{r}

```

